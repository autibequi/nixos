---
description: NixOS Configuration Rules - MCP Enhanced
globs:
- "*.nix"
- "flake.lock"
- "*.conf"
alwaysApply: true
---

# NIXOS CONFIGURATION ASSISTANT

## üéØ CONTEXTO DO SISTEMA
- **Distro**: NixOS 25.05 (stable) + nixos-unstable (selective packages)
- **Hardware**: ASUS Zephyrus GA402X
  - CPU: AMD Ryzen (configura√ß√µes em `modules/core/hardware.nix`)
  - GPU: NVIDIA (configura√ß√µes em `modules/nvidia.nix`)
- **Desktop**: GNOME (primary) + outros DEs opcionais
- **Boot Manager**: systemd-boot
- **Flake-based**: Sim (`flake.nix` √© a fonte da verdade)

## üîß FERRAMENTAS MCP DISPON√çVEIS

### Busca e Documenta√ß√£o
- **mcp_nixos_nixos_search**: Buscar pacotes, op√ß√µes, programas no NixOS
- **mcp_nixos_nixos_info**: Info detalhada sobre pacote/op√ß√£o espec√≠fica
- **mcp_nixos_nixos_channels**: Listar canais NixOS dispon√≠veis
- **mcp_nixos_nixos_stats**: Estat√≠sticas do reposit√≥rio NixOS

### Home Manager
- **mcp_nixos_home_manager_search**: Buscar op√ß√µes de configura√ß√£o do Home Manager
- **mcp_nixos_home_manager_info**: Info detalhada sobre op√ß√£o do Home Manager
- **mcp_nixos_home_manager_stats**: Estat√≠sticas do Home Manager
- **mcp_nixos_home_manager_options_by_prefix**: Listar op√ß√µes por prefixo (ex: `programs.git`)

### Flakes e Vers√µes
- **mcp_nixos_nixos_flakes_search**: Buscar flakes da comunidade
- **mcp_nixos_nixhub_package_versions**: Hist√≥rico de vers√µes de pacotes
- **mcp_nixos_nixhub_find_version**: Encontrar commit hash de vers√£o espec√≠fica

## üöÄ WORKFLOW RECOMENDADO

### Ao Adicionar/Modificar Pacotes
1. **Buscar pacote**: `mcp_nixos_nixos_search` com query descritiva
2. **Verificar op√ß√µes**: `mcp_nixos_nixos_info` para ver configura√ß√µes dispon√≠veis
3. **Checar vers√£o espec√≠fica**: Se precisar de vers√£o antiga, usar `mcp_nixos_nixhub_package_versions`
4. **Adicionar ao arquivo certo**: Ver se√ß√£o "ESTRUTURA DE ARQUIVOS"
5. **Testar**: `nh os test .` (OBRIGAT√ìRIO antes de commit)

### Ao Configurar Home Manager
1. **Buscar op√ß√£o**: `mcp_nixos_home_manager_search` com query
2. **Ver detalhes**: `mcp_nixos_home_manager_info` para tipo e valores aceitos
3. **Explorar categoria**: `mcp_nixos_home_manager_options_by_prefix` se quiser ver todas op√ß√µes de um programa
4. **Adicionar em**: `modules/core/home.nix` ou m√≥dulo espec√≠fico do DE

### Ao Resolver Problemas
1. **Verificar sistema**: `fastfetch -c all` para contexto completo
2. **Buscar op√ß√£o relacionada**: Usar MCP search para encontrar configura√ß√£o relevante
3. **Ler documenta√ß√£o inline**: MCP info retorna descri√ß√£o e exemplos
4. **Consultar nixpkgs**: LSP do nixd est√° dispon√≠vel para autocompletar

## üìÅ ESTRUTURA DE ARQUIVOS

### Arquivos Raiz
- `flake.nix` - Defini√ß√£o de inputs, outputs e configura√ß√£o do sistema
- `flake.lock` - Lock de vers√µes (n√£o editar manualmente)
- `configuration.nix` - Entry point, importa todos os m√≥dulos
- `hardware.nix` - Hardware scan gerado pelo nixos-generate-config

### Core Modules (`modules/core/`)
Configura√ß√µes essenciais que sempre carregam:
- `nix.nix` - Configura√ß√µes do Nix daemon (experimental features, substituters)
- `hardware.nix` - Hardware gen√©rico (OpenGL, firmware, drivers base)
- `core.nix` - Sistema base (timezone, locale, usu√°rios, networking)
- `home.nix` - Home Manager configuration
- `services.nix` - Servi√ßos essenciais do sistema
- `programs.nix` - Programas habilitados via nixpkgs programs.*
- `packages.nix` - Pacotes essenciais do sistema
- `fonts.nix` - Fontes do sistema
- `shell.nix` - Configura√ß√£o de shell (zsh, bash)
- `kernel.nix` - Par√¢metros e m√≥dulos do kernel
- `hibernate.nix` - Configura√ß√µes de hiberna√ß√£o/suspend

### Optional Modules (`modules/`)
M√≥dulos opcionais ativados por import em `configuration.nix`:
- `bluetooth.nix` - Bluetooth stack (bluez)
- `plymouth.nix` - Boot splash screen
- `nvidia.nix` - Driver NVIDIA (proprietary)
- `ai.nix` - Ferramentas de AI/ML (nixified-ai)
- `steam.nix` - Steam + gamescope
- `podman.nix` - Podman containers
- `docker.nix` - Docker (alternativa ao Podman, comentado por padr√£o)
- `flatpak.nix` - Flatpak support
- `work.nix` - Ferramentas de trabalho/produtividade
- `battery.nix` - Otimiza√ß√µes de bateria (TLP)
- `logitech-mouse.nix` - Configura√ß√µes de mouse Logitech

### Desktop Environments (`modules/gnome/`, etc)
Nota: A estrutura atual mostra `modules/gnome/` mas pode ter outros DEs:
- `gnome/core.nix` - Configura√ß√£o principal do GNOME
- `gnome/extensions.nix` - GNOME Shell extensions + dconf settings
- `gnome/extensions-configs/` - Arquivos de configura√ß√£o dedicados por extens√£o
- `gnome/packages.nix` - Pacotes espec√≠ficos do GNOME
- `gnome/home.nix` - Home Manager configs espec√≠ficas do GNOME

### Assets e Dotfiles
- `assets/wallpapers/` - Wallpapers do sistema
- `stow/` - Dotfiles gerenciados via GNU Stow
  - `ghostty/`, `git/`, `hyprland/`, `waybar/`, `zed/`, etc
- `scripts/` - Scripts de automa√ß√£o

### Tempor√°rios
- `tmp/done/` - Processos/sess√µes conclu√≠das
- `tmp/running/` - Processos em andamento (criar se necess√°rio)

## ‚öôÔ∏è COMANDOS E PR√ÅTICAS

### Build e Test
```bash
# SEMPRE usar para validar (n√£o precisa de sudo, funciona no sandbox)
nh os test .

# Aplicar na pr√≥xima reinicializa√ß√£o (usar ap√≥s test passar)
nh os boot .

# Ver o que mudou entre gera√ß√µes
nix store diff-closures /nix/var/nix/profiles/system-{OLDGEN,NEWGEN}-link

# Limpar gera√ß√µes antigas
nix-collect-garbage --delete-older-than 7d
```

### Flake Management
```bash
# Atualizar todos os inputs
nix flake update

# Atualizar input espec√≠fico
nix flake lock --update-input nixpkgs

# Ver metadata do flake
nix flake metadata

# Ver outputs dispon√≠veis
nix flake show
```

### Debugging
```bash
# Avaliar express√£o Nix
nix eval .#nixosConfigurations.nomad.config.OPTION

# Ver trace completo de build
nix build .#nixosConfigurations.nomad.config.system.build.toplevel --show-trace

# Verificar op√ß√µes aplicadas
nixos-option OPTION_PATH
```

### Busca no Sistema
```bash
# Buscar qual pacote fornece um arquivo
nix-locate --whole-name '/bin/PROGRAM'

# Ver depend√™ncias de um pacote
nix-store -q --tree /nix/store/HASH-PACKAGE
```

## üö´ RESTRI√á√ïES DO SANDBOX CURSOR

### NUNCA Fazer
- ‚ùå Usar `sudo` - todos comandos sudo falham no sandbox
- ‚ùå Usar `nh os switch .` - n√£o funciona em sandbox, usar `nh os test .`
- ‚ùå Editar `flake.lock` manualmente
- ‚ùå Adicionar pacotes que conflitem com sistema base
- ‚ùå Usar `nixos-rebuild` diretamente (usar `nh` wrapper)

### SEMPRE Fazer
- ‚úÖ Validar com `nh os test .` antes de commit
- ‚úÖ Usar MCP tools para buscar pacotes/op√ß√µes ANTES de adicionar
- ‚úÖ Verificar se op√ß√£o existe com `mcp_nixos_nixos_info`
- ‚úÖ Consultar Home Manager options com MCP antes de configurar
- ‚úÖ Usar containers/nix-shell quando precisar de ambiente isolado
- ‚úÖ Buscar na √°rvore de m√≥dulos por configura√ß√µes similares existentes

## üé® DECIS√ïES DE DESIGN

### Onde Adicionar Cada Coisa

#### Novo Pacote Global
- **CLI essencial**: `modules/core/packages.nix`
- **GUI/Desktop**: `modules/gnome/packages.nix` (ou DE apropriado)
- **Dev tool**: Criar `modules/dev.nix` ou adicionar em `work.nix`
- **Gaming**: `modules/steam.nix` ou criar `modules/gaming.nix`

#### Nova Configura√ß√£o de Programa
- **System-wide**: `modules/core/programs.nix` (usando `programs.*`)
- **Per-user**: `modules/core/home.nix` (usando Home Manager)
- **DE-specific**: No m√≥dulo do respectivo DE

#### Novo Servi√ßo
- **Essencial**: `modules/core/services.nix`
- **Opcional**: Criar m√≥dulo dedicado em `modules/NOME.nix`

#### Hardware Espec√≠fico
- **Generic hardware**: `modules/core/hardware.nix`
- **Device-specific**: Criar m√≥dulo em `modules/DEVICE.nix` (ex: `logitech-mouse.nix`)
- **Hardware scan**: `hardware.nix` (raiz)

## üîç TROUBLESHOOTING COMUM

### Build Falha
1. Verificar sintaxe: LSP do nixd geralmente indica
2. Testar express√£o isolada: `nix eval .#EXPR --show-trace`
3. Buscar op√ß√£o no MCP: Pode ter mudado de nome entre vers√µes
4. Ver logs completos: `nh os test . --verbose`

### Op√ß√£o N√£o Existe
1. Buscar com MCP search (pode ter nome diferente)
2. Verificar se est√° no canal certo (25.05 vs unstable)
3. Checar se precisa de overlay ou pacote unstable
4. Ver hist√≥rico: `mcp_nixos_nixhub_package_versions` para vers√µes antigas

### Performance Issues
1. Otimizar builds: `nix.settings.max-jobs`, `cores`
2. Limpar cache: `nix-collect-garbage -d`
3. Verificar substituers: `modules/core/nix.nix`

### Conflitos de Pacotes
1. Usar `nixpkgs-unstable` overlay para pacotes espec√≠ficos
2. Criar override com `pkgs.PACKAGE.overrideAttrs`
3. Pin vers√£o espec√≠fica com `mcp_nixos_nixhub_find_version`

## üìö RECURSOS EXTERNOS

### Documenta√ß√£o
- NixOS Options: https://search.nixos.org/options (ou usar MCP!)
- Home Manager: https://nix-community.github.io/home-manager/options.xhtml (ou usar MCP!)
- Nixpkgs Manual: https://nixos.org/manual/nixpkgs/stable/

### Inputs do Flake
- `nixpkgs` (25.05): Stable channel
- `nixpkgs-unstable`: Para pacotes bleeding-edge
- `chaotic`: CachyOS kernel e cache
- `home-manager`: Configura√ß√µes per-user
- `nixos-hardware`: Profiles para hardware espec√≠fico
- `nixified-ai`: AI/ML tooling

## üí° DICAS DE EFICI√äNCIA

### Antes de Modificar
1. **Sempre use MCP search primeiro** - economiza tempo procurando manualmente
2. **Leia a √°rvore de m√≥dulos** - configura√ß√£o similar pode j√° existir
3. **Verifique imports** no `configuration.nix` - m√≥dulo pode estar desabilitado

### Durante Modifica√ß√£o
1. **LSP est√° dispon√≠vel** - aproveite autocompletar do nixd
2. **Mantenha consist√™ncia** - siga padr√£o dos arquivos existentes
3. **Comente c√≥digo complexo** - Nix pode ser obscuro

### Ap√≥s Modifica√ß√£o
1. **Test SEMPRE** - `nh os test .` antes de commit
2. **Commit pequeno** - uma funcionalidade por vez
3. **Descreva o que fez** - commits descritivos ajudam no rollback

## ü§ñ PAPEL DO ASSISTENTE

Quando o usu√°rio pedir para:
- **Adicionar pacote**: Buscar no MCP, verificar op√ß√µes, adicionar no arquivo certo
- **Configurar programa**: Buscar op√ß√µes no MCP Home Manager, aplicar em home.nix
- **Resolver problema**: Buscar configura√ß√£o relacionada, propor solu√ß√£o testada
- **Otimizar sistema**: Analisar m√≥dulos, sugerir melhorias baseadas em MCP info
- **Atualizar pacote**: Usar nixhub MCP para encontrar vers√µes/commits

**Sempre ser proativo**:
- Sugerir melhorias al√©m do pedido
- Avisar sobre poss√≠veis conflitos
- Recomendar valida√ß√£o com `nh os test .`
- Explicar decis√µes de forma t√©cnica mas acess√≠vel (usu√°rio √© expert)

---

*Assistente MCP-Enhanced para NixOS - Vers√£o 2.0*
*Sistema: nomad (ASUS Zephyrus GA402X) - NixOS 25.05*
